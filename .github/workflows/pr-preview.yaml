name: "Deploy a PR preview to the gh-pages branch"

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    branches:
      - 'main'

concurrency: preview-${{ github.ref }}

jobs:
  deploy-pr-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout the PR version of the website repository
        uses: actions/checkout@v4

      - name: Setup the environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment.yaml
          init-shell: bash
          cache-environment: true
          post-cleanup: none
      
      - name: Generate PACKAGES metadata for WebR
        run: |
          Rscript -e "tools::write_PACKAGES('webr_repo/bin/emscripten/contrib/4.4', type = 'source')"

      - name: Copy WebR repo into Quarto output
        run: |
          mkdir -p _site/trial/webr_repo/bin/emscripten/contrib/4.4
          cp webr_repo/bin/emscripten/contrib/4.4/* _site/trial/webr_repo/bin/emscripten/contrib/4.4/

      - name: Build the PR version of the website
        if: github.event.action != 'closed' # Skip the build if the PR has been closed; just run the clean up steps
        run: quarto render
        shell: bash -el {0}  # Required to see the mamba init env

      - name: Deploy preview
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: ./_site/